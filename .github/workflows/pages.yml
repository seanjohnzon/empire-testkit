name: Deploy Snapshot

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Build a static snapshot using bash only (no npm/node scripts)
      - name: Build snapshot (bash only)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .snapshot/files

          # List tracked files and generate html pages with escaped content
          git ls-files | while read -r f; do
            # skip non-source folders
            case "$f" in
              node_modules/*|.git/*|.snapshot/*|.github/*|.vitest-reports/*|dist/*|build/*|coverage/*|.next/*)
                continue
                ;;
            esac
            mkdir -p ".snapshot/files/$(dirname "$f")"
            # Escape HTML and wrap in <pre>
            {
              echo '<!doctype html><meta charset="utf-8"><title>'"$f"'</title><h2>'"$f"'</h2><pre>'
              sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' "$f"
              echo '</pre>'
            } > ".snapshot/files/$f.html"
          done

          # Build index
          {
            echo '<!doctype html><meta charset="utf-8"><title>Empire Testkit Snapshot</title><h1>Empire Testkit Snapshot</h1><ul>'
            git ls-files | while read -r f; do
              case "$f" in
                node_modules/*|.git/*|.snapshot/*|.github/*|.vitest-reports/*|dist/*|build/*|coverage/*|.next/*) continue ;;
              esac
              echo "<li><a href=\"files/$f.html\">$f</a></li>"
            done
            echo '</ul>'
          } > .snapshot/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .snapshot

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
